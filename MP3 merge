from pathlib import Path
import numpy as np
import librosa
import soundfile as sf
import random

speaking_path = Path("/Users/jonassvirkaer/Desktop/Datasæt - Støj/Speach/Validering/Green Noise")
noise_path = Path("/Users/jonassvirkaer/Desktop/Datasæt - Støj/Støj-filer/Green Noise.wav")
export_path = Path("/Users/jonassvirkaer/Desktop/Datasæt - Støj/Speach/Validering/Green Noise/Done")

export_path.mkdir(parents=True, exist_ok=True)

noise, sr_noise = librosa.load(noise_path, sr=None, mono=True)

def rms(y):
    return np.sqrt(np.mean(y**2) + 1e-12)

for speech_file in speaking_path.glob("*.wav"):

    snr_db = random.uniform(8,20)
    noise_boost = 1.0
    print(f"Behandler: {speech_file.name} | SNR: {snr_db:.1f} dB")

    speech, sr_speech = librosa.load(speech_file, sr=None, mono=True)

    if sr_noise != sr_speech:
        noise_resampled = librosa.resample(noise, orig_sr=sr_noise, target_sr=sr_speech)
    else:
        noise_resampled = noise.copy()

    # Match længde (loop støjen)
    L = len(speech)
    if len(noise_resampled) < L:
        reps = int(np.ceil(L / len(noise_resampled)))
        noise_resampled = np.tile(noise_resampled, reps)
    noise_resampled = noise_resampled[:L]

    # ✅ Normaliser speech og noise til samme peak-niveau først
    speech = speech / (np.max(np.abs(speech)) + 1e-12)
    noise_resampled = noise_resampled / (np.max(np.abs(noise_resampled)) + 1e-12)

    # SNR-skalering
    rms_speech = rms(speech)
    rms_noise  = rms(noise_resampled)

    gain = rms_speech / (rms_noise * (10**(snr_db/20)))
    noise_scaled = noise_resampled * gain
    noise_scaled *= noise_boost

    mixed = speech + noise_scaled

    # Undgå clipping
    peak = np.max(np.abs(mixed)) + 1e-12
    if peak > 0.99:
        mixed = mixed / peak * 0.99

    out_file = export_path / f"{speech_file.stem}_snr{snr_db:.1f}_noisy.wav"
    sf.write(out_file, mixed, sr_speech)

print("Færdig med alle filer ✅")